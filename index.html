import { useState, useEffect } from "react";
import { Button } from "@/components/ui/button";
import { Card, CardContent } from "@/components/ui/card";
import { motion } from "framer-motion";

const suits = ["♠", "♣", "♦", "♥"];
const values = ["A", "2", "3", "4", "5", "6", "7", "8", "9", "10", "J", "Q", "K"];
const betOptions = [1000, 5000, 10000];

const shuffleDeck = () => {
  let deck = [];
  for (let suit of suits) {
    for (let value of values) {
      deck.push({ value, suit });
    }
  }
  return deck.sort(() => Math.random() - 0.5);
};

const getCardValue = (card) => {
  if (["J", "Q", "K", "10"].includes(card.value)) return 10;
  if (card.value === "A") return 1;
  return parseInt(card.value);
};

const calculatePoints = (hand) => {
  return hand.reduce((sum, card) => sum + getCardValue(card), 0) % 10;
};

export default function BaiCaoGame() {
  const [deck, setDeck] = useState([]);
  const [playerHand, setPlayerHand] = useState([]);
  const [dealerHand, setDealerHand] = useState([]);
  const [playerMoney, setPlayerMoney] = useState(50000);
  const [betAmount, setBetAmount] = useState(1000);
  const [result, setResult] = useState(null);

  useEffect(() => {
    setDeck(shuffleDeck());
  }, []);

  const startGame = () => {
    if (playerMoney < betAmount) {
      setResult("Không đủ tiền!");
      return;
    }
    
    let newDeck = shuffleDeck();
    let playerHand = [newDeck.pop(), newDeck.pop(), newDeck.pop()];
    let dealerHand = [newDeck.pop(), newDeck.pop(), newDeck.pop()];
    
    setPlayerHand(playerHand);
    setDealerHand(dealerHand);
    
    let playerPoints = calculatePoints(playerHand);
    let dealerPoints = calculatePoints(dealerHand);
    
    if (playerPoints > dealerPoints) {
      setPlayerMoney(playerMoney + betAmount);
      setResult("Bạn thắng!");
    } else if (playerPoints < dealerPoints) {
      setPlayerMoney(playerMoney - betAmount);
      setResult("Bạn thua!");
    } else {
      setResult("Hòa!");
    }
  };

  return (
    <div className="flex flex-col items-center p-4 bg-green-800 min-h-screen text-white">
      <h1 className="text-3xl font-bold mb-4">Game Bài Cao</h1>
      <p className="text-lg">Số tiền của bạn: ${playerMoney}</p>
      <div className="flex gap-2 my-4">
        {betOptions.map((bet) => (
          <Button key={bet} onClick={() => setBetAmount(bet)} variant={bet === betAmount ? "default" : "secondary"}>
            Cược {bet}$
          </Button>
        ))}
      </div>
      <Button onClick={startGame} className="mb-4">Chơi</Button>
      {result && <p className="text-xl font-bold my-2">{result}</p>}
      <div className="flex gap-4">
        <Card className="p-4 bg-gray-900">
          <h2 className="text-xl mb-2">Bài của bạn ({calculatePoints(playerHand)} điểm)</h2>
          <CardContent className="flex gap-2">
            {playerHand.map((card, index) => (
              <motion.div key={index} className="text-3xl" animate={{ scale: 1.1 }}>
                {card.value}{card.suit}
              </motion.div>
            ))}
          </CardContent>
        </Card>
        <Card className="p-4 bg-gray-900">
          <h2 className="text-xl mb-2">Bài của nhà cái ({calculatePoints(dealerHand)} điểm)</h2>
          <CardContent className="flex gap-2">
            {dealerHand.map((card, index) => (
              <motion.div key={index} className="text-3xl" animate={{ scale: 1.1 }}>
                {card.value}{card.suit}
              </motion.div>
            ))}
          </CardContent>
        </Card>
      </div>
    </div>
  );
}
